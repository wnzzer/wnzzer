# 自动生成并缓存 GitHub Profile 动态资源
# - 贡献蛇形图 (Platane/snk)
# - GitHub Stats 卡片 (缓存 github-readme-stats)
# - Activity Graph (缓存 github-readme-activity-graph)
name: Generate Profile Assets

on:
  schedule:
    # 每天 UTC 0:00（北京时间 8:00）运行
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # 拉取 output 分支已有缓存（首次运行时会失败，continue-on-error 处理）
      - name: Checkout existing output branch
        uses: actions/checkout@v4
        with:
          ref: output
          path: existing
        continue-on-error: true

      - name: Initialize dist with cached files
        run: |
          mkdir -p dist
          if [ -d existing ]; then
            cp existing/*.svg dist/ 2>/dev/null || true
          fi

      # 生成贡献蛇形图
      - name: Generate snake (dark + light)
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: wnzzer
          outputs: |
            dist/github-snake.svg
            dist/github-snake-dark.svg?palette=github-dark

      # 缓存 github-readme-stats 卡片（带重试，失败时保留旧缓存）
      - name: Cache github-readme-stats SVGs
        run: |
          fetch_svg() {
            local name="$1"
            local url="$2"
            echo "Fetching $name..."
            if curl -sf --retry 3 --retry-delay 30 --max-time 60 -o /tmp/"$name" "$url"; then
              # 检查返回的 SVG 是否包含错误信息
              if grep -q "Maximum retries exceeded\|Something went wrong\|Could not fetch\|PAT_1" /tmp/"$name" 2>/dev/null; then
                echo "::warning::$name contains error response, keeping cached version"
              else
                cp /tmp/"$name" dist/"$name"
                echo "✅ $name updated successfully"
              fi
            else
              echo "::warning::Failed to fetch $name (HTTP error), keeping cached version"
            fi
          }

          # Stats 卡片
          fetch_svg "stats.svg" \
            "https://github-readme-stats.vercel.app/api?username=wnzzer&show_icons=true&count_private=true&include_all_commits=true&title_color=00D9FF&icon_color=00ffa3&text_color=8B949E&bg_color=0D1117&hide_border=true&border_radius=15&ring_color=00D9FF"

          # Top Languages 卡片
          fetch_svg "top-langs.svg" \
            "https://github-readme-stats.vercel.app/api/top-langs/?username=wnzzer&layout=donut-vertical&title_color=00D9FF&text_color=8B949E&bg_color=0D1117&hide_border=true&border_radius=15&langs_count=8"

          # Pin 仓库卡片
          fetch_svg "pin-rank-analysis.svg" \
            "https://github-readme-stats.vercel.app/api/pin/?username=wnzzer&repo=rank-analysis&title_color=00D9FF&icon_color=00ffa3&text_color=8B949E&bg_color=0D1117&hide_border=true&border_radius=15"

          # Activity Graph
          fetch_svg "activity-graph.svg" \
            "https://github-readme-activity-graph.vercel.app/graph?username=wnzzer&bg_color=0d1117&color=00D9FF&line=00ffa3&point=ffffff&area_color=00D9FF&area=true&hide_border=true&custom_title=%F0%9F%93%88%20Contribution%20Graph"

      # 推送到 output 分支
      - name: Push to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
