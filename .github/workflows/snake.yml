# 自动生成 GitHub Profile 动态资源
# - 贡献蛇形图 (Platane/snk)
# - GitHub Stats / Top Langs / Pin 卡片 (本地生成，不依赖公共实例)
# - Activity Graph (缓存 github-readme-activity-graph)
name: Generate Profile Assets

on:
  schedule:
    # 每天 UTC 0:00（北京时间 8:00）运行
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # 拉取代码（需要 .github/scripts/ 下的生成脚本）
      - name: Checkout repository
        uses: actions/checkout@v4

      # 拉取 output 分支已有缓存（首次运行时会失败，continue-on-error 处理）
      - name: Checkout existing output branch
        uses: actions/checkout@v4
        with:
          ref: output
          path: existing
        continue-on-error: true

      - name: Initialize dist with cached files
        run: |
          mkdir -p dist
          if [ -d existing ]; then
            cp existing/*.svg dist/ 2>/dev/null || true
          fi

      # 生成贡献蛇形图
      - name: Generate snake (dark + light)
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: wnzzer
          outputs: |
            dist/github-snake.svg
            dist/github-snake-dark.svg?palette=github-dark

      # 通过 GitHub API 本地生成 Stats / Top Langs / Pin 卡片
      - name: Generate stats cards via GitHub API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_USER: wnzzer
          OUTPUT_DIR: dist
        run: python .github/scripts/generate_cards.py

      # 缓存 Activity Graph（来自不同服务，通常可用）
      - name: Cache activity graph
        run: |
          if curl -sf --retry 3 --retry-delay 30 --max-time 60 \
            -o /tmp/activity-graph.svg \
            "https://github-readme-activity-graph.vercel.app/graph?username=wnzzer&bg_color=0d1117&color=00D9FF&line=00ffa3&point=ffffff&area_color=00D9FF&area=true&hide_border=true&custom_title=%F0%9F%93%88%20Contribution%20Graph"; then
            cp /tmp/activity-graph.svg dist/activity-graph.svg
            echo "✅ activity-graph.svg updated"
          else
            echo "::warning::Failed to fetch activity graph, keeping cached version"
          fi

      # 推送到 output 分支
      - name: Push to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
